import React, { useEffect, useState } from 'react';

interface OptionScreenProps {
  onBack: () => void;
  onReset: () => void;
}

export const OptionScreen: React.FC<OptionScreenProps> = ({ onBack, onReset }) => {
  const [isEnabled, setIsEnabled] = React.useState<boolean>(false);
  const [isTransactionCheckerEnabled, setIsTransactionCheckerEnabled] = React.useState<boolean>(false);
  const [isOnchainNotificationEnabled, setIsOnchainNotificationEnabled] = React.useState<boolean>(false);
  const [isResetting, setIsResetting] = useState(false);
  const [apiKey, setApiKey] = useState<string>('');
  const [showApiKey, setShowApiKey] = useState<boolean>(false);
  const [copySuccess, setCopySuccess] = useState<boolean>(false);
  const [isWalletConnected, setIsWalletConnected] = useState<boolean>(false);

  useEffect(() => {
    // Load extension state, API key, and wallet connection status
    chrome.storage.local.get(['isEnabled', 'isTransactionCheckerEnabled', 'isOnchainNotificationEnabled', 'noditApiKey', 'walletAccount'], (result) => {
      console.log('Extension state loaded:', result);
      setIsEnabled(result.isEnabled ?? false);
      setIsTransactionCheckerEnabled(result.isTransactionCheckerEnabled ?? false);
      setIsOnchainNotificationEnabled(result.isOnchainNotificationEnabled ?? false);
      setApiKey(result.noditApiKey || '');
      setIsWalletConnected(!!result.walletAccount);
    });

    // Listen for wallet connection changes
    const handleStorageChange = (changes: { [key: string]: chrome.storage.StorageChange }, area: string) => {
      if (area === 'local' && changes.walletAccount) {
        const isConnected = !!changes.walletAccount.newValue;
        setIsWalletConnected(isConnected);
        console.log('üíº Wallet connection status changed:', isConnected);
        
        // ÏßÄÍ∞ëÏù¥ Ïó∞Í≤∞ Ìï¥Ï†úÎêòÎ©¥ On-chain NotificationÎèÑ ÏûêÎèôÏúºÎ°ú ÎπÑÌôúÏÑ±Ìôî
        if (!isConnected && isOnchainNotificationEnabled) {
          setIsOnchainNotificationEnabled(false);
          chrome.storage.local.set({ isOnchainNotificationEnabled: false });
          console.log('üîî On-chain Notification auto-disabled due to wallet disconnection');
        }
      }
    };

    chrome.storage.onChanged.addListener(handleStorageChange);

    // Cleanup listener on unmount
    return () => {
      chrome.storage.onChanged.removeListener(handleStorageChange);
    };
  }, [isOnchainNotificationEnabled]);

  const handleReset = async () => {
    setIsResetting(true);
    try {
      // Get the active tab
      const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
      const currentTab = tabs[0];
      
      if (currentTab?.id && currentTab.url?.startsWith('http')) {
        // Notify content script about reset
        try {
          await chrome.tabs.sendMessage(currentTab.id, { 
            type: 'TOGGLE_EXTENSION', 
            isEnabled: false 
          });
        } catch (err) {
          console.log('Content script not ready, continuing with reset');
        }
      }

      // Clear all stored data
      await chrome.storage.local.clear();
      
      // Reset extension state
      setIsEnabled(false);
      setApiKey('');
      
      // Notify parent component to show welcome screen
      onReset();
    } catch (error) {
      console.error('Error resetting Nodit Key:', error);
    } finally {
      setIsResetting(false);
    }
  };

  const handleToggle = async () => {
    const newState = !isEnabled;
    setIsEnabled(newState);
    
    // StorageÏóê Ï†ÄÏû•ÌïòÎ©¥ background scriptÍ∞Ä ÏûêÎèôÏúºÎ°ú Î™®Îì† ÌÉ≠Ïóê Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
    await chrome.storage.local.set({ isEnabled: newState });
    console.log(`üîÑ Extension state changed to: ${newState}`);
  };

  const handleTransactionCheckerToggle = async () => {
    const newState = !isTransactionCheckerEnabled;
    setIsTransactionCheckerEnabled(newState);
    
    // StorageÏóê Ï†ÄÏû•ÌïòÎ©¥ background scriptÍ∞Ä ÏûêÎèôÏúºÎ°ú Î™®Îì† ÌÉ≠Ïóê Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏
    await chrome.storage.local.set({ isTransactionCheckerEnabled: newState });
    console.log(`üîÑ Transaction Tracker state changed to: ${newState}`);
    
    // Î™®Îì† ÌÉ≠ÏóêÏÑú Ïä§ÌÅ¨Î¶ΩÌä∏ Ï£ºÏûÖ/Ï†úÍ±∞ Ï≤òÎ¶¨
    try {
      const tabs = await chrome.tabs.query({});
      const httpTabs = tabs.filter(tab => tab.id && tab.url?.startsWith('http'));
      
      console.log(`üìã Found ${httpTabs.length} HTTP tabs to ${newState ? 'inject' : 'cleanup'} Transaction Tracker`);

      if (newState) {
        // Ìä∏ÎûúÏû≠ÏÖò Ï≤¥Ïª§ ÌôúÏÑ±Ìôî: Î™®Îì† ÌÉ≠Ïóê transaction-checker.js Ï£ºÏûÖ
        const injectionResults = await Promise.allSettled(
          httpTabs.map(async (tab) => {
            try {
              await chrome.scripting.executeScript({
                target: { tabId: tab.id! },
                files: ['transaction-checker.js']
              });
              console.log(`‚úÖ Transaction Tracker injected in tab ${tab.id}: ${tab.url}`);
              return { success: true, tabId: tab.id };
            } catch (err) {
              console.error(`‚ùå Failed to inject in tab ${tab.id}:`, err);
              return { success: false, tabId: tab.id, error: err };
            }
          })
        );
        
        const successful = injectionResults.filter(result => 
          result.status === 'fulfilled' && result.value.success
        ).length;
        console.log(`üéØ Transaction Tracker injection completed: ${successful}/${httpTabs.length} tabs successful`);
        
      } else {
        // Ìä∏ÎûúÏû≠ÏÖò Ï≤¥Ïª§ ÎπÑÌôúÏÑ±Ìôî: Î™®Îì† ÌÉ≠Ïóê Ï†ïÎ¶¨ Î©îÏãúÏßÄ Ï†ÑÏÜ°
        const cleanupResults = await Promise.allSettled(
          httpTabs.map(async (tab) => {
            try {
              await chrome.tabs.sendMessage(tab.id!, { 
                type: 'CLEANUP_TRANSACTION_CHECKER'
              });
              console.log(`‚úÖ Transaction Tracker cleanup sent to tab ${tab.id}`);
              return { success: true, tabId: tab.id };
            } catch (err) {
              console.log(`‚ö†Ô∏è Cleanup message failed for tab ${tab.id} (script may not be active)`);
              return { success: false, tabId: tab.id, error: err };
            }
          })
        );
        
        const successful = cleanupResults.filter(result => 
          result.status === 'fulfilled' && result.value.success
        ).length;
        console.log(`üßπ Transaction Tracker cleanup completed: ${successful}/${httpTabs.length} tabs successful`);
      }
      
    } catch (error) {
      console.error('Error handling transaction Tracker script for all tabs:', error);
    }
  };

  const handleOnchainNotificationToggle = async () => {
    // ÏßÄÍ∞ëÏù¥ Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùÄ ÏÉÅÌÉúÏóêÏÑú ÌôúÏÑ±ÌôîÌïòÎ†§Í≥† ÌïòÎ©¥ Í≤ΩÍ≥†
    if (!isWalletConnected && !isOnchainNotificationEnabled) {
      alert('‚ö†Ô∏è On-chain NotificationÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ Î®ºÏ†Ä ÏßÄÍ∞ëÏùÑ Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî!');
      return;
    }

    const newState = !isOnchainNotificationEnabled;
    setIsOnchainNotificationEnabled(newState);
    await chrome.storage.local.set({ isOnchainNotificationEnabled: newState });
    console.log(`üîî On-chain Notification state changed to: ${newState}`);
    
    // TODO: Ìñ•ÌõÑ Ïä§Ìä∏Î¶º Ïó∞Í≤∞ Í∏∞Îä• Íµ¨ÌòÑ ÏòàÏ†ï
    // ÌòÑÏû¨Îäî Îã®ÏàúÌûà ÏÉÅÌÉú Î≥ÄÍ≤ΩÎßå ÏàòÌñâ
  };

  const handleCopyApiKey = async () => {
    if (!apiKey) return;
    
    try {
      await navigator.clipboard.writeText(apiKey);
      setCopySuccess(true);
      setTimeout(() => setCopySuccess(false), 2000);
    } catch (err) {
      console.error('Failed to copy API key:', err);
    }
  };

  const maskApiKey = (key: string): string => {
    if (!key) return '';
    if (key.length <= 8) return key;
    return `${key.substring(0, 4)}${'‚Ä¢'.repeat(key.length - 8)}${key.substring(key.length - 4)}`;
  };

  const ToggleButton: React.FC<{ isActive: boolean; onClick: () => void }> = ({ isActive, onClick }) => (
    <button
      onClick={onClick}
      style={{
        width: '40px',
        height: '24px',
        backgroundColor: isActive ? '#00d16c' : '#444',
        borderRadius: '20px',
        border: 'none',
        position: 'relative',
        cursor: 'pointer',
        transition: 'background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
        boxShadow: isActive ? '0 2px 8px rgba(0, 209, 108, 0.3)' : '0 1px 3px rgba(0, 0, 0, 0.2)',
      }}
    >
      <div
        style={{
          position: 'absolute',
          top: '4px',
          left: isActive ? '20px' : '4px',
          width: '16px',
          height: '16px',
          background: '#fff',
          borderRadius: '50%',
          transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
          transform: isActive ? 'scale(1.1)' : 'scale(1)',
          boxShadow: '0 1px 3px rgba(0, 0, 0, 0.2)',
        }}
      />
    </button>
  );

  return (
    <div style={{
      margin: 0,
      padding: 0,
      backgroundColor: '#000',
      fontFamily: "'Noto Sans KR', sans-serif",
      color: 'white',
      width: '100%',
      height: '100%',
    }}>
      <div style={{
        padding: '16px',
        maxWidth: '400px',
        margin: '0 auto',
        display: 'flex',
        flexDirection: 'column',
      }}>
        {/* Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          marginBottom: '20px',
          position: 'relative',
        }}>
          <span
            onClick={onBack}
            style={{
              fontSize: '20px',
              cursor: 'pointer',
              position: 'absolute',
              left: 0,
            }}
          >
            ‚Üê
          </span>
          <span style={{
            fontSize: '20px',
            fontWeight: 'bold',
          }}>
            Setting
          </span>
        </div>

        {/* ÏÑ§Ï†ï Ï†ïÎ≥¥ ÏÑπÏÖò */}
        <section>
          <h2 style={{
            fontSize: '18px',
            fontWeight: 'bold',
            marginBottom: '12px',
          }}>
            ÏÑ§Ï†ï Ï†ïÎ≥¥
          </h2>
          <div style={{
            backgroundColor: '#1a1a1a',
            borderRadius: '12px',
            padding: '16px',
            marginBottom: '30px',
          }}>
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '12px 0',
              borderBottom: '1px solid #333',
            }}>
              <div>
                <strong>Account Tracker</strong>
                <p style={{
                  fontSize: '13px',
                  color: '#aaa',
                  marginTop: '4px',
                  margin: '4px 0 0 0',
                }}>
                  Ïõπ ÏÉÅÏùò Ï£ºÏÜåÎ•º ÎìúÎûòÍ∑∏ÌïòÎ©¥ Ï†ïÎ≥¥Î•º Î∂ÑÏÑùÌï©ÎãàÎã§.
                </p>
              </div>
              <ToggleButton isActive={isEnabled} onClick={handleToggle} />
            </div>

            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '12px 0',
              borderBottom: '1px solid #333',
            }}>
              <div>
                <strong>Transaction Tracker</strong>
                <p style={{
                  fontSize: '13px',
                  color: '#aaa',
                  marginTop: '4px',
                  margin: '4px 0 0 0',
                }}>
                  Ìä∏ÎûúÏû≠ÏÖò Î∞úÏÉùÏãú Î∂ÑÏÑùÌïòÏó¨ Ïù∏ÏÇ¨Ïù¥Ìä∏Î•º Ï†úÍ≥µÌï©ÎãàÎã§.
                </p>
              </div>
              <ToggleButton isActive={isTransactionCheckerEnabled} onClick={handleTransactionCheckerToggle} />
            </div>

            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '12px 0',
              borderBottom: '1px solid #333',
              opacity: isWalletConnected ? 1 : 0.5,
            }}>
              <div>
                <strong>On-chain Notification</strong>
                <p style={{
                  fontSize: '13px',
                  color: isWalletConnected ? '#aaa' : '#666',
                  marginTop: '4px',
                  margin: '4px 0 0 0',
                }}>
                  {isWalletConnected 
                    ? 'ÎÇ¥ Í≥ÑÏ†ïÏùò Ïò®Ï≤¥Ïù∏ ÌôúÎèôÏù¥ Í∞êÏßÄÎêòÎ©¥ ÏïåÎ†§Ï§çÎãàÎã§.'
                    : '‚ö†Ô∏è ÏßÄÍ∞ë Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.'
                  }
                </p>
              </div>
              <ToggleButton 
                isActive={isOnchainNotificationEnabled} 
                onClick={isWalletConnected ? handleOnchainNotificationToggle : () => {
                  alert('‚ö†Ô∏è On-chain NotificationÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ Î®ºÏ†Ä ÏßÄÍ∞ëÏùÑ Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî!');
                }}
              />
            </div>

            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '12px 0',
              borderBottom: '1px solid #333',
            }}>
              <div>
                <strong>Dark Mode</strong>
                <p style={{
                  fontSize: '13px',
                  color: '#aaa',
                  marginTop: '4px',
                  margin: '4px 0 0 0',
                }}>
                  Îã§ÌÅ¨ Î™®Îìú UIÎ•º Ï†ÅÏö©Ìï©ÎãàÎã§.
                </p>
              </div>
              <ToggleButton isActive={true} onClick={() => {}} />
            </div>

            {/* <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '12px 0',
            }}>
              <div>
                <strong>Auto Connect</strong>
                <p style={{
                  fontSize: '13px',
                  color: '#aaa',
                  marginTop: '4px',
                  margin: '4px 0 0 0',
                }}>
                  Î°úÍ∑∏Ïù∏ Ïãú API Key Î∞è ÏßÄÍ∞ëÏùÑ ÏûêÎèôÏúºÎ°ú Ïó∞Í≤∞Ìï©ÎãàÎã§.
                </p>
              </div>
              <ToggleButton isActive={false} onClick={() => {}} />
            </div> */}
          </div>
        </section>

        {/* Nodit API Key ÏÑπÏÖò */}
        {apiKey && (
          <section>
            <h2 style={{
              fontSize: '18px',
              fontWeight: 'bold',
              marginBottom: '12px',
            }}>
              Nodit API Key
            </h2>
            <div style={{
              backgroundColor: '#1a1a1a',
              borderRadius: '12px',
              padding: '16px',
              marginBottom: '30px',
            }}>
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: '8px',
              }}>
                <strong>Ïó∞Í≤∞Îêú Key</strong>
                <span
                  onClick={() => setShowApiKey(!showApiKey)}
                  style={{
                    fontSize: '16px',
                    cursor: 'pointer',
                  }}
                >
                  üëÅ
                </span>
              </div>
              
              <input
                type={showApiKey ? 'text' : 'password'}
                value={showApiKey ? apiKey : maskApiKey(apiKey)}
                readOnly
                style={{
                  width: '100%',
                  padding: '10px',
                  border: 'none',
                  backgroundColor: '#333',
                  borderRadius: '8px',
                  color: 'white',
                  marginBottom: '12px',
                  boxSizing: 'border-box',
                  fontFamily: 'monospace',
                  fontSize: '12px',
                }}
              />
              
              <p style={{
                fontSize: '13px',
                color: '#aaa',
                lineHeight: '1.4',
                marginBottom: '16px',
                margin: '0 0 16px 0',
              }}>
                Ïù¥ ÌÇ§Îäî Î∏îÎ°ùÏ≤¥Ïù∏ Î∂ÑÏÑù Î∞è Ìä∏ÎûúÏû≠ÏÖò Ï≤¥ÌÇπÏóê ÏÇ¨Ïö©Îê©ÎãàÎã§. ÌÇ§Î•º ÏïàÏ†ÑÌïòÍ≤å Î≥¥Í¥ÄÌïòÍ≥† ÌÉÄÏù∏Í≥º Í≥µÏú†ÌïòÏßÄ ÎßàÏÑ∏Ïöî.
              </p>
              
              <button
                onClick={handleReset}
                disabled={isResetting}
                style={{
                  width: '100%',
                  backgroundColor: isResetting ? 'rgba(0, 209, 108, 0.7)' : '#00d16c',
                  color: 'black',
                  padding: '12px',
                  border: 'none',
                  borderRadius: '10px',
                  fontSize: '15px',
                  fontWeight: 'bold',
                  cursor: isResetting ? 'not-allowed' : 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '8px',
                }}
              >
                {isResetting && (
                  <div style={{
                    width: '16px',
                    height: '16px',
                    border: '2px solid rgba(0, 0, 0, 0.3)',
                    borderTop: '2px solid black',
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite',
                  }} />
                )}
                {isResetting ? 'Resetting...' : 'Reset API Key'}
              </button>
            </div>
          </section>
        )}

        {/* Footer */}
        <footer style={{
          textAlign: 'center',
          fontSize: '12px',
          color: '#777',
          marginTop: '20px',
        }}>
          Powered by Nodit
        </footer>
      </div>

      {/* CSS Animation */}
      <style>
        {`
          @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
          }
        `}
      </style>
    </div>
  );
}; 